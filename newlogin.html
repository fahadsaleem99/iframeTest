<!DOCTYPE html>
<html>
<style>
.image-txt-container {
  display: flex;
  align-items: center;
  flex-direction: row;
}
.cardtext {
  display: flex;
  align-content: end;
  align-items: start;
  flex-direction: column;
}
.button {
  border: none;
  color: white;
  padding: 15px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 40px;
  margin: 4px 2px;
  cursor: pointer;
}
.button1 {
  border: none;
  border:none;
  margin:0;
  padding:0;
  color: white;
  font-size: 40px;
  text-align: center;
  text-decoration: none;
  
  
  margin: 4px 2px;
  cursor: pointer;
}
.button1 {background-color: #White;border-radius: 50px;} /* Blue */
.button2 {background-color: #008CBA;border-radius: 50px;} /* Blue */
</style>
<body>
<div id="g_id_onload"
      data-prompt_parent_id="g_id_onload"
      data-cancel_on_tap_outside="false"
      style="position: absolute; left: 15%; top: 300px; width: 0; height: 0; z-index: 500;">
 		</div>	
<div class="image-txt-container">
	<p>&nbsp;&nbsp;&nbsp;</p>
	</div>

	<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
    	window.onload = async function initiateSpc() {
    		
		console.log('Window onload function started');
    		
    		//new part
    		
			
    		const publicKeyCredentialRequestOptions = {  
				// Server generated challenge  
				challenge: Uint8Array.from("4A54657686543D3CABCD", c => c.charCodeAt(0)),
				
				//allowCredentials: [{
				//use NORMAL base64 data NOT the url-safe base64 data generated by key creation response
				//id:	base64ToArray("AYvbMGEYKYlh+eoC5aqmmV5vvc1vCFoyonKDmo/uYynvV9kAnD/1DlWNa44S1Y6uzcHZIFLReDK3RRy3Ls27+8A="),
        //type: 'public-key',
        //transports: ['internal'],
    //}],
				
				// The same RP ID as used during registration  
				//rpId: 'localhost',
				rpId: 'fahadsaleem99.github.io',
				//rpId: '192.168.86.173',  
				userVerification: "required",
				allowCredentials: [{
				//use NORMAL base64 data NOT the url-safe base64 data generated by key creation response
				//id:	base64ToArray("AYvbMGEYKYlh+eoC5aqmmV5vvc1vCFoyonKDmo/uYynvV9kAnD/1DlWNa44S1Y6uzcHZIFLReDK3RRy3Ls27+8A="),
        			//type: 'public-key',
        			transports: ['internal']
    				}],
				};

		try {
			const credential = await navigator.credentials.get({  
				publicKey: publicKeyCredentialRequestOptions,  
				//signal: abortController.signal,  
				// Specify 'conditional' to activate conditional UI  
				//mediation: 'conditional'
				});
				
			console.log(credential);
			console.log("response id: " + credential.id);
			var rawIdentity = new Uint8Array(credential.rawId);
			const rawIdData = buf2hex(rawIdentity);
			console.log("Raw Identity: " + rawIdData);
			
			const utf8Decoder = new TextDecoder('utf-8');
			const decodedClientData = utf8Decoder.decode(credential.response.clientDataJSON);
			// parse the string as an object
			const clientDataObj = JSON.parse(decodedClientData);
			var str = JSON.stringify(clientDataObj, null, 4);
			console.log("Decoded Client Data JSON:" + str);
			
			//console.log(credential.response.authenticatorData);
			
			var authDataAssertion = new Uint8Array(credential.response.authenticatorData);
			//console.log(authDataAssertion);
			const authDataAssert = buf2hex(authDataAssertion)
			console.log("Auth Data from AssertionHex: " + authDataAssert)
			//console.log(buf2hex(authDataAssertion));
			
			var signatureAssertion = new Uint8Array(credential.response.signature);
			//console.log(uint8View);
			const sigAssertion = buf2hex(signatureAssertion)
			console.log("Assertion Signature Hex: " + sigAssertion)
			//console.log(buf2hex(signatureAssertion));
			
			var userHandleResponse = new Uint8Array(credential.response.userHandle);
			//console.log(uint8View);
			const userHandle = buf2hex(userHandleResponse)
			console.log("User Handle Hex: " + userHandle)
			//console.log(buf2hex(userHandleResponse));
			
			//var auth_data = new Uint8Array(attestation.response.authenticatorData);
			let data_hash = new Uint8Array(await crypto.subtle.digest('SHA-256', credential.response.clientDataJSON));
			//var data_hash = sha256(new Uint8Array(credential.response.clientDataJSON));
			var signed    = new Uint8Array(authDataAssertion.length + data_hash.length);
			
			//Uint8Array.set(Uint8Array[data, offset])
			signed.set(authDataAssertion);
			signed.set(data_hash, authDataAssertion.length);
			
			const dataString = buf2hex(signed)
			console.log("Data string for signature verification in hex: " + dataString)
    		
    		//end new part
    		
    		window.parent.postMessage({action: 'Ready'}, "*");
    		console.log("sent postMessage Ready to parent iframe");
    		
    		//myWindow.contentWindow.postMessage(
    		//{action: 'Authenticate'},event.origin)
    		
    		return new Promise((resolve, reject) => {
    		window.addEventListener("message", (event) => {
  // Do we trust the sender of this message?
  if (event.origin !== "https://clicktopaydemo.w3spaces.com") 
  	{console.log('This is not what I want. Wrong source');
  		return;}
    		//window.addEventListener('message', ({ data, source, origin }) => {
          console.log('Source::', event.source);
          console.log('data::', event.data);
          console.log('Origin::', event.origin);
          switch (event.data.action) {
            case 'Cards':
              //return window.postMessage({
              console.log('I got this::', event.data);
		console.log('Card list sent!');
		window.parent.postMessage({action: 'Success'}, "*");
              //authSpc()
              
              
          }
        })
    		
    		})
    		
    	
		}
		catch(error) {
			console.log('passkey was cancelled');
			console.error("An error occurred:", error); 
			getAccount();
			function parseJwt (token) {
    			var base64Url = token.split('.')[1];
    			var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    			var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        		return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    			}).join(''));

    			return JSON.parse(jsonPayload);
				};
				
        function getToken() {
          console.log("Launching DCF");
          window.location.href="checkout.html";
        
        }
        function handleCredentialResponse(response) {
          console.log("Encoded JWT ID token: " + response.credential);
          console.log("Selected by: " + response.select_by);
          const responsePayload = response.credential;
          let payload= parseJwt(responsePayload);
					console.log("payload:- ", payload);
					const emailadd = payload.email;
					console.log('Email: ' + emailadd);
					const firstname = payload.given_name;
					console.log('First Name: ' + firstname);
					const lastname = payload.family_name;
					console.log('Last Name: ' + lastname);
					window.parent.postMessage({action: 'Success'}, "*");
					
					
          
        }
        function getAccount () {
          google.accounts.id.initialize({
            client_id: "519692674221-t3g010bf048gg9oc2iurlm9spqv9peb6.apps.googleusercontent.com",
            auto_select: true,
            ux_mode: "popup",
            nonce: "srcclientId",
            context: "continue",
            prompt_parent_id: 'g_id_onload',
            callback: handleCredentialResponse
          });
          
          //google.accounts.id.prompt(); // also display the One Tap dialog
          google.accounts.id.prompt((notification) => {
      			if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
        		// continue with another identity provider.
        		console.log("One Tap Not displayed or skipped reason", notification.getNotDisplayedReason());
        		
      			}
      			console.log("One Tap Displayed?", notification.isDisplayed());
      			console.log("One Tap Not Displayed?", notification.isNotDisplayed());
      		});
        }
    
  }
		}
    	
    	
    	
    	
    	</script>  

<script src="/iframeTest/cbor.js" type="text/javascript"></script>

<script>
    function arrayBufferToString(input) {
  	return String.fromCharCode(...new Uint8Array(input));
  	}
  
  function arrayBufferToBase64(input) {
  	return btoa(arrayBufferToString(input));
  	}
    	
    	
    	function toHexString(byteArray) {
    		return Array.from(byteArray, function(byte) {
    			return ('0' + (byte & 0xFF).toString(16)).slice(-2);
    			}).join('')
    			}
    	
    	function buf2hex(buffer) { // buffer is an ArrayBuffer
    		return [...new Uint8Array(buffer)]
    		.map(x => x.toString(16).padStart(2, '0'))
    		.join('');
    		}
    	
    	function ab2str(buf) {
    		return String.fromCharCode.apply(null, new Uint8Array(buf));
    		}
    	
    	function base64ToArray(input) {
    		return Uint8Array.from(atob(input), c => c.charCodeAt(0))
    		}
    	//verification
    	async function authSpc() {
    		
    		console.log("cred in storage: " + window.localStorage.getItem("windowLocalStorageIdentifier"))
    		const request = new PaymentRequest([{
    			// Specify `secure-payment-confirmation` as payment method.
    			supportedMethods: "secure-payment-confirmation",
    			data: {
    				// The RP ID
    				rpId: 'localhost',
    				//rpId: '192.168.86.173',
    				//rpId: 'clicktopaydemo.w3spaces.com',
    				
    				//USE the base64 credential ID (not the url-safe one)
    				// List of credential IDs obtained from the RP server.
    				
    				//credentialIds: [base64ToArray(window.localStorage.getItem("windowLocalStorageIdentifier"))],
    				
    				//pixel8
    				credentialIds: [base64ToArray("h3ISpZQ4jdsYzLM3vDPFdw=="), base64ToArray("qUqh4+gkAo2MkWqPQOpsSdT3PKUPK8vJPR1krcAYvD8=")],
    				
    				
    				// The challenge is also obtained from the RP server.
    				challenge: Uint8Array.from("4A54657686543D3CABCD", c => c.charCodeAt(0)),
    				
    				networkInfo:{
    				name:"Mastercard",
    				icon: "http://localhost:8000/ma_symbol_opt_73_3x.png"
    				},
    				
    				issuerInfo: {
    				name: "Citibank",
    				icon: "http://localhost:8000/ps-citibank-01.avif"
    				},
    				
    				// A display name and an icon that represent the payment instrument.
    				instrument: {
    					displayName: "Citi Commercial Mastercard ****5043",
    					//icon: "http:localhost:5000/mastercard.png",
    					icon: "https://assets.mastercard.com/card-art/combined-image-asset/0f64ea97-497a-44bc-87cd-7b87fb72fed1.png",
    					iconMustBeShown: true
    					},
    				
    				// The origin of the payee (merchant)
    				payeeOrigin: "https://mystore.com",
    			
    				// The number of milliseconds to timeout.
    				timeout: 10000,  // 6 minutes
    				}
    				
    				}], {
    				// Payment details.
    				total: {
    					label: "Total",
    					amount: {
    						currency: "USD",
    						value: "24.99",
    						},
    						},
    						});
    						
    						
    		
    			const response = await request.show();
    			
    			// response.details is a PublicKeyCredential, with a clientDataJSON that
    			// contains the transaction data for verification by the issuing bank.
    			// Make sure to serialize the binary part of the credential before
    			// transferring to the server.
    			
    			console.log(response);
    			
    			
			console.log("response id: " + response.details.id);
			
			const utf8Decoder = new TextDecoder('utf-8');
			const decodedClientData = utf8Decoder.decode(response.details.response.clientDataJSON);
			// parse the string as an object
			const clientDataObj = JSON.parse(decodedClientData);
			var str = JSON.stringify(clientDataObj, null, 4);
			console.log("Decoded Client Data JSON:" + str);
			
			//console.log(credential.response.authenticatorData);
			
			var authDataAssertion = new Uint8Array(response.details.response.authenticatorData);
			//console.log(authDataAssertion);
			const authDataAssert = buf2hex(authDataAssertion)
			console.log("Auth Data from AssertionHex: " + authDataAssert)
			//console.log(buf2hex(authDataAssertion));
			
			var signatureAssertion = new Uint8Array(response.details.response.signature);
			//console.log(uint8View);
			const sigAssertion = buf2hex(signatureAssertion)
			console.log("Assertion Signature Hex: " + sigAssertion)
			//console.log(buf2hex(signatureAssertion));
			
			var userHandleResponse = new Uint8Array(response.details.response.userHandle);
			//console.log(uint8View);
			const userHandle = buf2hex(userHandleResponse)
			console.log("User Handle Hex: " + userHandle)
			//console.log(buf2hex(userHandleResponse));
			
			//var auth_data = new Uint8Array(attestation.response.authenticatorData);
			let data_hash = new Uint8Array(await crypto.subtle.digest('SHA-256', response.details.response.clientDataJSON));
			//var data_hash = sha256(new Uint8Array(credential.response.clientDataJSON));
			var signed    = new Uint8Array(authDataAssertion.length + data_hash.length);
			
			//Uint8Array.set(Uint8Array[data, offset])
			signed.set(authDataAssertion);
			signed.set(data_hash, authDataAssertion.length);
			
			const dataString = buf2hex(signed)
			console.log("Data string for signature verification in hex: " + dataString)
    			
    			
    			
    			await response.complete('success');
    			//alert("Payment successfully completed!!!");
    			return response;
    			//return new Promise(resolve => {
    				//response;
    				//});
    		
    		} 								
      
     </script>   	
    	
    	
		
</body>
</html>
